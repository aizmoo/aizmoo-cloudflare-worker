name: Xray Proxy Server

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to keep the proxy running (in minutes)'
        required: false
        default: '30'

jobs:
  run-xray:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Xray
        run: |
          echo "Installing Xray..."
          wget https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip Xray-linux-64.zip
          chmod +x xray
          ./xray version

      - name: Install Cloudflared
        run: |
          echo "Installing Cloudflared (Cloudflare Tunnel)..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          cloudflared --version
          echo "âœ… Cloudflared installed (no token required)"

      - name: Create Xray config
        run: |
          cat > config.json << 'EOF'
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "port": 10186,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "e4e6cef9-8308-44ff-9783-16441309096d",
                      "flow": "xtls-rprx-vision"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "tcp",
                  "security": "reality",
                  "realitySettings": {
                    "dest": "www.microsoft.com:443",
                    "serverNames": ["www.microsoft.com"],
                    "privateKey": "4G2f9-bVbRs4BYQM-lVMqugGgyl7pRlBe5P98TBvfUI",
                    "shortIds": [""]
                  }
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": ["http", "tls", "quic"]
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct"
              },
              {
                "protocol": "blackhole",
                "tag": "block"
              }
            ]
          }
          EOF
          echo "Xray configuration created"
          cat config.json

      - name: Get Server IP Information
        run: |
          echo "================================"
          echo "Server IP Information:"
          echo "================================"
          echo "Public IPv4:"
          curl -4 -s https://api.ipify.org || echo "Failed to get IPv4"
          echo ""
          echo "Public IPv6:"
          curl -6 -s https://api.ipify.org || echo "No IPv6 available"
          echo ""
          echo "Detailed IP Info:"
          curl -s https://ipinfo.io || echo "Failed to get detailed info"
          echo ""
          echo "================================"
          echo "Xray Server Details:"
          echo "================================"
          echo "Protocol: VLESS"
          echo "Port: 10186"
          echo "UUID: e4e6cef9-8308-44ff-9783-16441309096d"
          echo "Flow: xtls-rprx-vision"
          echo "Network: tcp"
          echo "Security: reality"
          echo "SNI: www.microsoft.com"
          echo ""
          if [ -n "$TUNNEL_URL" ]; then
            echo "================================"
            echo "Cloudflare Tunnel Public Access:"
            echo "================================"
            echo "Public URL: $TUNNEL_URL"
            echo "Host: $TUNNEL_HOST"
            echo "Port: $TUNNEL_PORT"
            echo "================================"
            echo "Connection Details:"
            echo "================================"
            echo "Server: $TUNNEL_HOST"
            echo "Port: $TUNNEL_PORT"
            echo "UUID: e4e6cef9-8308-44ff-9783-16441309096d"
            echo "Flow: xtls-rprx-vision"
            echo "Network: tcp"
            echo "Security: reality"
            echo "SNI: www.microsoft.com"
            echo "================================"
          fi

      - name: Start Xray
        run: |
          echo "Starting Xray proxy server..."
          ./xray run -config config.json &
          XRAY_PID=$!
          echo "Xray started with PID: $XRAY_PID"
          
          # Wait a moment for Xray to start
          sleep 5
          
          # Check if Xray is running
          if ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray is running successfully on port 10186"
          else
            echo "âŒ Xray failed to start"
            exit 1
          fi
          
          # Check if port is listening
          if netstat -tuln | grep -q ":10186"; then
            echo "âœ… Port 10186 is listening"
          else
            echo "âš ï¸  Port 10186 might not be accessible"
          fi

      - name: Start Cloudflare Tunnel
        run: |
          echo "Starting Cloudflare Tunnel..."
          # Start cloudflared TCP tunnel in background and capture output
          # Redirect both stdout and stderr to log file
          cloudflared tunnel --url tcp://localhost:10186 > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo "Cloudflared started with PID: $TUNNEL_PID"
          echo "Monitoring tunnel establishment..."
          
          # Wait for tunnel to establish and poll for URL
          echo "Waiting for tunnel to establish..."
          TUNNEL_URL=""
          for i in {1..30}; do
            sleep 2
            # Try multiple extraction methods
            # Method 1: Look for trycloudflare.com URLs
            TUNNEL_URL=$(grep -oE 'tcp://[a-z0-9-]+\.trycloudflare\.com:[0-9]+' tunnel.log 2>/dev/null | grep -v localhost | head -1)
            
            # Method 2: Look for any tcp:// URL with trycloudflare
            if [ -z "$TUNNEL_URL" ]; then
              TUNNEL_URL=$(grep -iE 'trycloudflare' tunnel.log 2>/dev/null | grep -oE 'tcp://[^ ]+' | grep -v localhost | head -1)
            fi
            
            # Method 3: Look in the box/banner output
            if [ -z "$TUNNEL_URL" ]; then
              TUNNEL_URL=$(grep -A 2 -B 2 'quick Tunnel' tunnel.log 2>/dev/null | grep -oE 'tcp://[a-z0-9-]+\.trycloudflare\.com:[0-9]+' | head -1)
            fi
            
            if [ -n "$TUNNEL_URL" ]; then
              echo "âœ… Found tunnel URL after $((i * 2)) seconds"
              echo "Raw extracted URL: $TUNNEL_URL"
              # Show the matching line from log for verification
              echo "Matching log line:"
              grep -E 'trycloudflare' tunnel.log | grep -E 'tcp://' | head -1 || echo "Not found in log"
              break
            fi
            
            if [ $((i % 5)) -eq 0 ]; then
              echo "Still waiting... ($((i * 2))s elapsed)"
              echo "Recent log output:"
              tail -5 tunnel.log || true
            fi
          done
          
          # Final check - show full log if still not found
          if [ -z "$TUNNEL_URL" ]; then
            echo "âš ï¸  Could not extract URL automatically. Showing full log:"
            echo "=========================================="
            cat tunnel.log
            echo "=========================================="
            echo ""
            echo "Attempting manual extraction from log..."
            # Try to find any URL pattern more aggressively
            TUNNEL_URL=$(cat tunnel.log | grep -oE 'tcp://[a-zA-Z0-9.-]+\.trycloudflare\.com:[0-9]+' | grep -v localhost | head -1)
            
            if [ -z "$TUNNEL_URL" ]; then
              echo "âŒ Failed to extract tunnel URL. Please check the log above manually."
              echo "Look for a line containing 'tcp://' and 'trycloudflare.com'"
              exit 1
            fi
          fi
          
          # Clean up the URL (remove any trailing characters)
          TUNNEL_URL=$(echo "$TUNNEL_URL" | sed 's/[^a-zA-Z0-9:.\/-]//g')
          
          echo "âœ… Cloudflare Tunnel established"
          echo "Public URL: $TUNNEL_URL"
          
          # Show relevant log lines for debugging
          echo ""
          echo "Relevant log lines containing tunnel info:"
          grep -iE '(tcp://|trycloudflare|quick tunnel|tunnel created)' tunnel.log | head -10 || echo "No matching lines found"
          echo ""
          
          # Extract host and port from tunnel URL (format: tcp://xxxx.trycloudflare.com:12345)
          TUNNEL_HOST=$(echo $TUNNEL_URL | sed 's|tcp://||' | cut -d: -f1)
          TUNNEL_PORT=$(echo $TUNNEL_URL | sed 's|tcp://||' | cut -d: -f2)
          
          # Validate extracted values
          if [ -z "$TUNNEL_HOST" ] || [ -z "$TUNNEL_PORT" ] || [ "$TUNNEL_HOST" == "localhost" ]; then
            echo "âŒ Failed to parse tunnel URL correctly"
            echo "Extracted URL: $TUNNEL_URL"
            echo "Extracted Host: $TUNNEL_HOST"
            echo "Extracted Port: $TUNNEL_PORT"
            echo ""
            echo "Full tunnel log for debugging:"
            echo "=========================================="
            cat tunnel.log
            echo "=========================================="
            exit 1
          fi
          
          echo "TUNNEL_HOST=$TUNNEL_HOST" >> $GITHUB_ENV
          echo "TUNNEL_PORT=$TUNNEL_PORT" >> $GITHUB_ENV
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo ""
          echo "================================"
          echo "Tunnel Connection Info:"
          echo "================================"
          echo "Host: $TUNNEL_HOST"
          echo "Port: $TUNNEL_PORT"
          echo "Full URL: $TUNNEL_URL"
          echo "================================"

      - name: Keep Alive
        run: |
          DURATION=${{ github.event.inputs.duration }}
          if [ -z "$DURATION" ]; then
            DURATION=30
          fi
          
          echo "Keeping proxy alive for $DURATION minutes..."
          echo ""
          echo "================================"
          echo "Connection Information:"
          echo "================================"
          if [ -n "$TUNNEL_URL" ]; then
            echo "ðŸŒ Public Access via Cloudflare Tunnel:"
            echo "  Server: $TUNNEL_HOST"
            echo "  Port: $TUNNEL_PORT"
            echo "  Full URL: $TUNNEL_URL"
          else
            echo "âš ï¸  Tunnel URL not available"
            PUBLIC_IP=$(curl -4 -s https://api.ipify.org)
            echo "  Server: $PUBLIC_IP"
            echo "  Port: 10186"
          fi
          echo ""
          echo "Xray Configuration:"
          echo "  UUID: e4e6cef9-8308-44ff-9783-16441309096d"
          echo "  Flow: xtls-rprx-vision"
          echo "  Network: tcp"
          echo "  Security: reality"
          echo "  SNI: www.microsoft.com"
          echo ""
          echo "Connection will remain active until: $(date -d "+$DURATION minutes" 2>/dev/null || date -v +${DURATION}M)"
          echo "================================"
          
          # Keep the workflow running
          SECONDS=$((DURATION * 60))
          for ((i=1; i<=SECONDS; i++)); do
            if [ $((i % 60)) -eq 0 ]; then
              REMAINING=$((SECONDS - i))
              echo "â±ï¸  Still running... $(($REMAINING / 60)) minutes remaining"
            fi
            sleep 1
          done
          
          echo "âœ… Proxy session completed"

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping services..."
          echo "Stopping Cloudflare Tunnel..."
          pkill -f cloudflared || true
          echo "Stopping Xray..."
          pkill -f xray || true
          echo "âœ… Cleanup completed"

